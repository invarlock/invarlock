name: repo-hygiene

on:
  pull_request:
    branches: [ main ]

jobs:
  no-generated-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Detect forbidden files in PR diff
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          files="$(git diff --name-only --diff-filter=AM "$base" "$head")"
          if echo "$files" | grep -E '^(site/|node_modules/|dist/|build/|reports_report/|reports_.*/|runs/)' ; then
            echo "❌ Generated artifacts detected in the PR diff."; exit 1;
          else
            echo "✅ No generated artifacts in the PR diff.";
          fi
      - name: Ensure no duplicate test basenames
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t dups < <(find tests -type f -name 'test_*.py' -exec basename {} \; | sort | uniq -d)
          if [ ${#dups[@]} -gt 0 ]; then
            echo "❌ Duplicate test filenames detected:";
            printf '  - %s\n' "${dups[@]}";
            exit 1;
          fi
          echo "✅ No duplicate test basenames in tests/."

  large-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Prevent >10MB files in PR diff
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          threshold=$((10 * 1024 * 1024))
          rc=0
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            sz=$(wc -c <"$f")
            if [ "$sz" -gt "$threshold" ]; then
              echo "❌ $f is ${sz} bytes (>10MB)"; rc=1
            fi
          done < <(git diff --name-only --diff-filter=AM "$base" "$head")
          exit $rc
