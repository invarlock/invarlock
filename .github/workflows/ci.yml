name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
    paths-ignore:
      # Cost optimization: don't run full CI for docs-only changes
      # docs-ci.yml handles these
      - 'docs/**'
      - '*.md'
      - '.markdownlint*'
      - 'mkdocs.yml'
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.markdownlint*'
      - 'mkdocs.yml'

permissions:
  contents: read

jobs:
  # Single test job (Python 3.13)
  tests-docs:
    runs-on: ubuntu-latest
    env:
      INVARLOCK_LIGHT_IMPORT: "1"
      INVARLOCK_DISABLE_PLUGIN_DISCOVERY: "0"
      PYTHONWARNINGS: "default"
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.13-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.13-

      - name: Install (core + hf + docs)
        run: |
          python -m pip install -U pip wheel
          pip install -e .[hf]
          pip install pytest mkdocs mkdocs-material mkdocs-mermaid2-plugin

      - name: Curated tests (light import for help/doctor)
        run: |
          pytest -q \
            tests/cli/test_python_m_invarlock.py \
            tests/cli/test_report_help_and_html.py \
            tests/cli/test_doctor_json.py \
            tests/cli/test_doctor_cross_checks.py \
            tests/cli/test_doctor_json_cls_pseudo_counts.py \
            tests/cli/test_doctor_json_cls_measured_no_d012.py \
            tests/cli/test_doctor_json_tiny_relax_note.py \
            tests/integration/scripts/test_tiny_matrix_checklist.py \
            tests/reporting/test_certificate_schema_v1_accuracy_tags.py \
            tests/reporting/test_cert_markdown_estimated_suffix.py \
            tests/reporting/test_cert_markdown_no_estimated_for_measured.py

      - name: Allow-list contracts (fast unit set)
        run: |
          pytest -q \
            tests/reporting/test_certificate_acceptance.py \
            tests/cli/test_console_validation_block.py \
            tests/cli/test_verify_json_shape.py::test_verify_json_envelope_is_stable \
            tests/cli/test_verify_json_single_line.py::test_verify_json_single_line \
            tests/cli/test_plugins_json_shape.py \
            tests/cli/test_doctor_json_format_version.py \
            tests/docs/test_docs_lexicon.py \
            tests/docs/test_docs_schema_label.py \
            tests/reporting/test_evidence_bundle.py \
            tests/ci/test_golden_runs_offline.py

      - name: Docs build (strict)
        run: |
          mkdocs build --strict

  # Supply-chain security (weekly + tags only to save cost)
  supply-chain:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install supply-chain tools
        run: |
          python -m pip install -U pip pip-audit cyclonedx-bom

      - name: Generate SBOM
        run: bash scripts/generate_sbom.sh

      - name: Run pip-audit
        run: pip-audit --ignore-vuln GHSA-4xh5-x5gv-qwph || true
